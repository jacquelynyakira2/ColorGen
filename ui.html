<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColorGen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* Custom styles for the UI elements */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #ffffff;
            width: 375px;
            height: 700px; /* Set height to accommodate sticky header and footer */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }
        .nav-button {
            background-color: #FFFFFF;
            color: #374151;
            transition: all 0.2s;
            padding: 16px;
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #E5E7EB; /* Add gray border */
            border-radius: 12px; /* Add 12px corner radius */
        }
        .nav-button:hover {
            background-color: #F9FAFB;
        }
        .color-picker {
            width: 24px !important;
            height: 24px !important;
            border-radius: 4px; /* Add this line for rounded corners */
            cursor: pointer; /* Add this line to show it's clickable */
        }
        header, footer {
            position: sticky;
            background: #ffffff;
            z-index: 10;
            width: 100%;
        }
        header {
            top: 0;
        }
        footer {
            bottom: 0;
        }
        .content {
            flex: 1;
            width: 100%;
        }
        .gradient-container {
            width: 100%;
        }
        .font-mono {
            font-family: 'Source Code Pro', monospace;
        }
        .color-swatch {
            height: 48px;
            border-radius: 24px;
            position: relative;
            cursor: pointer;
        }
        .color-swatch-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 8px;
            font-size: 16px;
            font-weight: 500;
        }
        .material-icons {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 18px;
        }
        /* Add this new class for the bottom border */
        .header-divider, footer > div {
            border-bottom: 1px solid #D1D5DB;
            border-top: 1px solid #D1D5DB;
            padding: 16px;
        }
        /* Add these retro styles to your existing styles */
        .retro-window {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.2);
            padding: 2px;
        }

        .retro-title-bar {
            background: linear-gradient(90deg, #000080, #1084d0);
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px #000000;
        }

        .retro-button {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            box-shadow: 1px 1px 0px rgba(0, 0, 0, 0.2);
            transition: all 0.1s;
        }

        .retro-button:active {
            border-color: #808080 #ffffff #ffffff #808080;
            transform: translate(1px, 1px);
        }

        .retro-score {
            background: #000000;
            color: #00ff00;
            font-family: 'Source Code Pro', monospace;
            padding: 4px 8px;
            border: 1px solid #808080;
            text-shadow: 0 0 5px #00ff00;
        }

        .retro-message {
            font-family: 'Source Code Pro', monospace;
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
            background: #000000;
            padding: 8px;
            border: 1px solid #808080;
        }

        /* Update Mac OS classic styles */
        .mac-window {
            background: #DDDDDD;
            border: 1px solid #000000;
            border-radius: 5px 5px 3px 3px;
            font-family: "Chicago", system-ui, -apple-system, sans-serif;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .mac-title-bar {
            background: linear-gradient(90deg, 
                #666666 0%,
                #999999 2%,
                #999999 98%,
                #666666 100%
            );
            height: 22px;
            border-radius: 4px 4px 0 0;
            border-bottom: 1px solid #000000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000000;
            font-size: 13px;
        }

        .mac-title-bar::before {
            content: "";
            position: absolute;
            left: 9px;
            top: 50%;
            transform: translateY(-50%);
            width: 13px;
            height: 13px;
            background: linear-gradient(135deg, #FF8080 0%, #FF0000 100%);
            border: 1px solid #880000;
            border-radius: 50%;
            box-shadow: inset 0 2px 2px rgba(255, 255, 255, 0.4);
        }

        .mac-content {
            background: #DDDDDD;
            padding: 16px;
            border-radius: 0 0 3px 3px;
        }

        .mac-button {
            background: linear-gradient(180deg, #FFFFFF 0%, #DDDDDD 100%);
            border: 1px solid #000000;
            border-radius: 3px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.1s;
        }

        .mac-button:active {
            background: linear-gradient(180deg, #DDDDDD 0%, #CCCCCC 100%);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.2);
        }

        .mac-score {
            background: #FFFFFF;
            border: 1px solid #666666;
            border-radius: 3px;
            padding: 4px 8px;
            font-family: "Monaco", monospace;
            font-size: 12px;
            box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.1);
            color: #000000;
        }

        .mac-game-over {
            background: #DDDDDD;
            border: 1px solid #666666;
            border-radius: 3px;
            padding: 16px;
            text-align: center;
            font-family: "Chicago", system-ui, -apple-system, sans-serif;
        }

        .mac-play-button {
            background: linear-gradient(180deg, #FFFFFF 0%, #DDDDDD 100%);
            border: 1px solid #000000;
            border-radius: 3px;
            padding: 4px 12px;
            font-family: "Chicago", system-ui, -apple-system, sans-serif;
            font-size: 12px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
            color: #000000;
        }

        .mac-play-button:active {
            background: linear-gradient(180deg, #DDDDDD 0%, #CCCCCC 100%);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.2);
        }

        .mac-message {
            font-family: "Chicago", system-ui, -apple-system, sans-serif;
            font-size: 12px;
            background: #DDDDDD;
            border: 1px solid #666666;
            border-radius: 3px;
            padding: 8px;
            color: #000000;
        }
    </style>
</head>
<body class="bg-[#FFFFFF] h-screen flex flex-col text-[#1D1D1F]">
    <!-- Main menu container -->
    <div id="main-menu" class="content flex-grow flex flex-col p-4 space-y-2">
        <!-- Buttons for different features -->
        <button id="generatePalette" class="nav-button">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor" class="mr-2">
                    <path d="M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 32.5-156t88-127Q256-817 330-848.5T488-880q80 0 151 27.5t124.5 76q53.5 48.5 85 115T880-518q0 115-70 176.5T640-280h-74q-9 0-12.5 5t-3.5 11q0 12 15 34.5t15 51.5q0 50-27.5 74T480-80Zm0-400Zm-220 40q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm120-160q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm200 0q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm120 160q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17ZM480-160q9 0 14.5-5t5.5-13q0-14-15-33t-15-57q0-42 29-67t71-25h70q66 0 113-38.5T800-518q0-121-92.5-201.5T488-800q-136 0-232 93t-96 227q0 133 93.5 226.5T480-160Z"/>
                </svg>
                <span style="font-size: 16px;">Color Generator</span>
            </div>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
        <button id="generateGradient" class="nav-button">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <span style="font-size: 16px;">Gradient</span>
            </div>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
        <button id="generateScale" class="nav-button">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                </svg>
                <span style="font-size: 16px;">Color Scale</span>
            </div>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
        <button id="startHSLGame" class="nav-button">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span style="font-size: 16px;">Have Some Fun</span>
            </div>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
    </div>

    <!-- Feature view container (initially hidden) -->
    <div id="feature-view" class="hidden flex-grow flex flex-col">
        <!-- Header with back button and feature title -->
        <header class="bg-white p-4 flex items-center header-divider sticky top-0">
            <button id="back-button" class="mr-4">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
            </button>
            <h2 id="feature-title" class="text-sm font-regular"></h2>
        </header>
        <!-- Content area for the selected feature -->
        <div id="feature-content" class="flex-grow p-4 w-full h-full"></div>
        <!-- Footer with action buttons -->
        <footer class="sticky bottom-0 bg-white">
            <div class="p-4 flex justify-between items-center border-t border-[#D1D5DB]">
                <button id="generate-button" class="bg-white hover:bg-gray-100 text-black font-regular py-2 px-4 rounded-[24px] border-2 border-black flex-grow mr-2 transition-colors">
                    Generate
                </button>
                <button id="add-to-figma-button" class="bg-white hover:bg-gray-100 text-black font-regular p-2 rounded-full border-2 border-black flex items-center justify-center transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                </button>
            </div>
        </footer>
    </div>

    <script>
        // Global variables
        let currentPickr = null;
        let currentStreak = 0;
        let bestStreak = 0;
        const STREAK_MILESTONES = [3, 5, 10, 15, 20, 25, 30];

        // Game-specific global variables
        let gameStyle = 'modern';
        let currentHSLColor;
        let differentColorIndex;
        let score = 0;
        let difficulty = 1;
        let gameOver = false;
        let highestScore = 0;

        function generateRandomColor() {
            return {
                h: Math.floor(Math.random() * 360),
                s: 70 + Math.floor(Math.random() * 31), // 70-100 for more vibrant colors
                l: 40 + Math.floor(Math.random() * 21), // 40-60 for medium brightness
            };
        }

        function hslToHex(h, s, l) {
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }

        // Function to initialize color pickers
        function initializeColorPickers() {
            const colorSwatches = document.querySelectorAll('[id^="color-swatch-"]');
            colorSwatches.forEach(swatch => {
                const index = parseInt(swatch.dataset.index);
                swatch.onclick = () => openColorPicker(swatch, index);
            });
        }

        function openColorPicker(swatch, index) {
            const currentColor = swatch.dataset.color;
            
            // Create a temporary input element
            const input = document.createElement('input');
            input.type = 'color';
            input.value = currentColor;
            
            // Style and position the input
            Object.assign(input.style, {
                position: 'absolute',
                opacity: '0',
                height: '1px',
                width: '1px',
                padding: '0',
                margin: '0',
                border: 'none',
                cursor: 'pointer'
            });

            // Add the input to the DOM
            document.body.appendChild(input);
            
            // Trigger a click on the input to open the color picker
            input.click();

            // Listen for changes on the input
            input.addEventListener('input', function() {
                const newColor = this.value.toUpperCase();
                updateGradientColor(index, newColor);
            });

            // Remove the input when the color picker is closed
            input.addEventListener('change', function() {
                document.body.removeChild(this);
            });
        }

        function updateGradientColor(index, newColor) {
            // Update the UI immediately
            const swatch = document.getElementById(`color-swatch-${index}`);
            const hexText = document.getElementById(`color-hex-${index}`);
            if (swatch) {
                swatch.style.backgroundColor = newColor;
                swatch.dataset.color = newColor;
            }
            if (hexText) {
                hexText.textContent = newColor.toUpperCase();
            }

            // Update the gradient preview
            const gradientPreview = document.getElementById('gradient-preview');
            if (gradientPreview) {
                let gradient = JSON.parse(gradientPreview.dataset.gradient);
                gradient.gradientStops[index].color = hexToRgb(newColor);
                const gradientCSS = getGradientCSS(gradient);
                gradientPreview.style.background = gradientCSS;
                gradientPreview.dataset.gradient = JSON.stringify(gradient);
            }

            // Send message to the plugin
            parent.postMessage({
                pluginMessage: {
                    type: 'edit-gradient-color',
                    index: index,
                    newColor: newColor
                }
            }, '*');
        }

        // Add this helper function if it doesn't exist
        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            return { r, g, b, a: 1 };
        }

        function updateGradientPreview(gradient) {
            const gradientPreview = document.getElementById('gradient-preview');
            const gradientContainer = document.getElementById('gradient-container');
            
            if (gradientPreview && gradientContainer) {
                const gradientCSS = getGradientCSS(gradient);
                gradientPreview.style.background = gradientCSS;
                gradientPreview.dataset.gradient = JSON.stringify(gradient);

                // Update color swatches
                gradientContainer.innerHTML = createGradientSwatchesHTML(gradient);
                initializeColorPickers();
            }
        }

        function createGradientHTML(gradient) {
            const gradientCSS = getGradientCSS(gradient);
            
            return `
                <div class="flex flex-col h-full">
                    <div id="gradient-preview" class="flex-grow rounded-md cursor-pointer shadow-sm hover:shadow-md transition duration-300 mb-4" 
                        style="background: ${gradientCSS}; min-height: 200px;" 
                        data-gradient='${JSON.stringify(gradient)}'
                        onclick="applyGradientToSelection('${JSON.stringify(gradient)}')">
                    </div>
                    <div id="gradient-container" class="flex justify-between gap-4">
                        ${createGradientSwatchesHTML(gradient)}
                    </div>
                </div>
            `;
        }

        function createGradientSwatchesHTML(gradient) {
            return gradient.gradientStops.map((stop, index) => `
                <div class="flex flex-col items-center">
                    <div id="color-swatch-${index}" class="w-8 h-8 rounded-full cursor-pointer color-picker border-2 border-white mb-2" 
                        data-color="${rgbToHex(stop.color)}"
                        data-index="${index}"
                        data-position="${stop.position * 100}"
                        style="background-color: ${rgbToHex(stop.color)};">
                    </div>
                    <span id="color-hex-${index}" class="text-xs font-mono">${rgbToHex(stop.color).toUpperCase()}</span>
                </div>
            `).join('');
        }

        // Function to show the feature view
        function showFeatureView(title, content, containerHeight) {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('feature-view').classList.remove('hidden');
            
            // Create header content with style toggle for Fun feature
            let headerContent = title;
            if (title === 'Fun') {
                headerContent = `
                    <div class="flex items-center w-full gap-4">
                        <div class="flex items-center gap-4 min-w-0">
                            <span>${title}</span>
                        </div>
                        <div class="ml-auto inline-flex rounded-lg border border-gray-200 p-1">
                            <button 
                                id="modern-style-btn"
                                class="px-3 py-1 rounded-md text-xs ${gameStyle === 'modern' ? 'bg-black text-white' : 'text-gray-600 hover:bg-gray-100'}"
                            >
                                Modern
                            </button>
                            <button 
                                id="win95-style-btn"
                                class="px-3 py-1 rounded-md text-xs ${gameStyle === 'win95' ? 'bg-black text-white' : 'text-gray-600 hover:bg-gray-100'}"
                            >
                                Windows 95
                            </button>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('feature-title').innerHTML = headerContent;
            const featureContent = document.getElementById('feature-content');
            featureContent.innerHTML = content;
            featureContent.style.height = containerHeight || 'auto';
            
            // Add event listeners for style buttons if they exist
            const modernBtn = document.getElementById('modern-style-btn');
            const win95Btn = document.getElementById('win95-style-btn');
            
            if (modernBtn) {
                modernBtn.addEventListener('click', () => switchGameStyle('modern'));
            }
            if (win95Btn) {
                win95Btn.addEventListener('click', () => switchGameStyle('win95'));
            }
            
            // Rest of the existing showFeatureView code...
            const generateButton = document.getElementById('generate-button');
            const addToFigmaButton = document.getElementById('add-to-figma-button');
            const footerDiv = document.querySelector('.p-4.border-t');
            
            if (title === 'Fun') {
                generateButton.style.display = 'none';
                addToFigmaButton.style.display = 'none';
                if (footerDiv) footerDiv.style.display = 'none';
            } else if (title === 'Color Palette' || title === 'Color Scale') {
                generateButton.style.display = 'block';
                addToFigmaButton.style.display = 'block';
                if (footerDiv) footerDiv.style.display = 'flex';
            } else if (title === 'Gradient') {
                generateButton.style.display = 'block';
                addToFigmaButton.style.display = 'none';
                if (footerDiv) footerDiv.style.display = 'flex';
            } else {
                generateButton.style.display = 'none';
                addToFigmaButton.style.display = 'block';
                if (footerDiv) footerDiv.style.display = 'flex';
            }
            
            initializeColorPickers();
            initializeGradientPreview();
        }

        // Function to show the main menu
        function showMainMenu() {
            document.getElementById('feature-view').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        }

        // Event listeners for main menu buttons
        document.getElementById('generatePalette').onclick = () => {
            parent.postMessage({ pluginMessage: { type: 'generate-palette' } }, '*');
        };

        document.getElementById('generateGradient').onclick = () => {
            console.log("Generate Gradient button clicked");
            parent.postMessage({ pluginMessage: { type: 'generate-gradient' } }, '*');
        };

        document.getElementById('generateScale').onclick = () => {
            parent.postMessage({ pluginMessage: { type: 'generate-scale' } }, '*');
        };

        document.getElementById('startHSLGame').onclick = () => {
            // Initialize game state
            gameStyle = 'modern';
            currentHSLColor = generateRandomColor();
            differentColorIndex = Math.floor(Math.random() * 6);
            score = 0;
            currentStreak = 0;
            difficulty = 1;
            gameOver = false;
            
            // Show game UI
            showFeatureView('Fun', createGameHTML(), 'auto');
            
            // Add event listeners for style buttons
            const modernBtn = document.getElementById('modern-style-btn');
            const win95Btn = document.getElementById('win95-style-btn');
            
            if (modernBtn) {
                modernBtn.addEventListener('click', () => switchGameStyle('modern'));
            }
            if (win95Btn) {
                win95Btn.addEventListener('click', () => switchGameStyle('win95'));
            }
        };

        document.getElementById('back-button').onclick = showMainMenu;

        // Functions to communicate with the main script
        function applyColor(color) {
            parent.postMessage({ pluginMessage: { type: 'apply-color', color: color } }, '*');
        }

        function applyGradient(gradientString) {
            try {
                const gradient = JSON.parse(gradientString);
                parent.postMessage({ pluginMessage: { type: 'apply-gradient', gradient: gradient } }, '*');
            } catch (error) {
                console.error('Error parsing gradient:', error);
                console.error('Problematic gradient string:', gradientString);
            }
        }

        function toggleLock(index) {
            parent.postMessage({ pluginMessage: { type: 'toggle-lock', index: index } }, '*');
        }

        function addPaletteToFigma() {
            parent.postMessage({ pluginMessage: { type: 'add-palette-to-figma' } }, '*');
        }

        function addScaleToFigma() {
            parent.postMessage({ pluginMessage: { type: 'add-scale-to-figma' } }, '*');
        }

        function checkAnswer(answerString) {
            try {
                const answer = JSON.parse(answerString);
                parent.postMessage({ pluginMessage: { type: 'check-answer', answer: answer } }, '*');
            } catch (error) {
                console.error('Error parsing answer:', error);
            }
        }

        function changeHarmonyType(harmonyType) {
            parent.postMessage({ pluginMessage: { type: 'change-harmony-type', harmonyType: harmonyType } }, '*');
        }

        function startGame(index) {
            parent.postMessage({ pluginMessage: { type: 'start-game', index: index } }, '*');
        }

        function checkAnswer(index) {
            parent.postMessage({ pluginMessage: { type: 'check-answer', index: index } }, '*');
        }

        // Event listeners for action buttons
        document.getElementById('add-to-figma-button').onclick = () => {
            const currentFeature = document.getElementById('feature-title').textContent;
            if (currentFeature === 'Color Palette') {
                parent.postMessage({ pluginMessage: { type: 'add-palette-to-figma' } }, '*');
            } else if (currentFeature === 'Color Scale') {
                addScaleToFigma();
            }
        };

        document.getElementById('generate-button').onclick = () => {
            const currentFeature = document.getElementById('feature-title').textContent;
            if (currentFeature === 'Color Palette') {
                parent.postMessage({ pluginMessage: { type: 'generate-palette' } }, '*');
            } else if (currentFeature === 'Color Scale') {
                parent.postMessage({ pluginMessage: { type: 'generate-scale' } }, '*');
            } else if (currentFeature === 'Gradient') {
                parent.postMessage({ pluginMessage: { type: 'generate-gradient' } }, '*');
            }
        };

        // Message handler for communication with the main script
        window.onmessage = (event) => {
            const message = event.data.pluginMessage;
            if (message.type === 'update-ui') {
                console.log("Received update-ui message:", message);
                showFeatureView(message.title, message.html, message.containerHeight);
                
                if (message.title === 'Gradient') {
                    initializeColorPickers();
                } else if (message.title === 'Fun') {
                    // Initialize game when showing game UI
                    currentHSLColor = generateRandomColor();
                    differentColorIndex = Math.floor(Math.random() * 6);
                }
            } else if (message.type === 'update-gradient') {
                updateGradientPreview(message.gradient);
            } else if (message.type === 'update-game') {
                document.getElementById('feature-content').innerHTML = message.html;
            } else if (message.type === 'show-game-ui') {
                showGameUI(message.html);
                // Initialize game when showing game UI
                currentHSLColor = generateRandomColor();
                differentColorIndex = Math.floor(Math.random() * 6);
            }
        };

        // Additional functions
        function startHSLGame() {
            currentHSLColor = generateRandomColor();
            differentColorIndex = Math.floor(Math.random() * 6);
            score = 0;
            currentStreak = 0;
            difficulty = 1;
            gameOver = false;
            updateGameUI();
        }

        function showGameUI(gameHTML) {
            showFeatureView('Fun', gameHTML, 'auto');
        }

        function checkGameAnswer(index) {
            if (gameOver) return;

            if (index === differentColorIndex) {
                currentStreak++;
                if (currentStreak > bestStreak) {
                    bestStreak = currentStreak;
                }
                score++;
                difficulty += 0.2;
                
                // Celebrate streak milestones
                celebrateStreak(currentStreak);
                
                // Generate new colors
                currentHSLColor = generateRandomColor();
                differentColorIndex = Math.floor(Math.random() * 6);
            } else {
                gameOver = true;
                currentStreak = 0;
                highestScore = Math.max(highestScore, score);
            }
            updateGameUI();
        }

        function restartGame() {
            startHSLGame();
        }

        function applyGradientToSelection(gradient) {
          console.log('applyGradientToSelection called with gradient:', gradient);
          parent.postMessage({
            pluginMessage: {
              type: 'apply-gradient',
              gradient: {
                type: 'GRADIENT_LINEAR',
                gradientTransform: [
                  [1, 0, 0],
                  [0, 1, 0],
                ],
                gradientStops: gradient.gradientStops.map(stop => ({
                  position: stop.position,
                  color: {
                    r: stop.color.r,
                    g: stop.color.g,
                    b: stop.color.b,
                    a: stop.color.a || 1
                  }
                }))
              }
            }
          }, '*');
        }

        function rgbToHex({ r, g, b }) {
            return '#' + [r, g, b].map(x => Math.round(x * 255).toString(16).padStart(2, '0')).join('');
        }

        function initializeGradientPreview() {
            console.log('initializeGradientPreview called');
            const gradientPreview = document.getElementById('gradient-preview');
            if (gradientPreview) {
                console.log('Gradient preview element found');
                gradientPreview.onclick = function() {
                    console.log('Gradient preview clicked');
                    const gradient = JSON.parse(this.dataset.gradient);
                    console.log('Gradient data:', gradient);
                    applyGradientToSelection(gradient);
                };
            } else {
                console.log('Gradient preview element not found');
            }
        }

        function getGradientCSS(gradient) {
            const stops = gradient.gradientStops
                .map(stop => `rgba(${stop.color.r * 255}, ${stop.color.g * 255}, ${stop.color.b * 255}, ${stop.color.a}) ${stop.position * 100}%`)
                .join(', ');
            return `linear-gradient(to right, ${stops})`;
        }

        function getRandomGradientDirection() {
            // Array of common gradient directions with weights
            // Higher weight = more likely to be selected
            const directions = [
                { angle: '90deg', weight: 50 },    // left to right (most common)
                { angle: '45deg', weight: 15 },    // top-left to bottom-right
                { angle: '135deg', weight: 15 },   // top-right to bottom-left
                { angle: '180deg', weight: 20 }    // top to bottom
            ];
            
            // Calculate total weight
            const totalWeight = directions.reduce((sum, dir) => sum + dir.weight, 0);
            
            // Generate random number between 0 and total weight
            let random = Math.random() * totalWeight;
            
            // Find the selected direction based on weights
            for (const direction of directions) {
                random -= direction.weight;
                if (random <= 0) {
                    return direction.angle;
                }
            }
            
            // Fallback to left-to-right
            return '90deg';
        }

        function updateGradient(colors) {
            const direction = getRandomGradientDirection();
            const gradientContainer = document.querySelector('.gradient-container');
            
            if (gradientContainer) {
                const gradient = `linear-gradient(${direction}, ${colors.join(', ')})`;
                gradientContainer.style.background = gradient;
            }
        }

        function celebrateStreak(streak) {
            // Different celebrations for different streak levels
            if (STREAK_MILESTONES.includes(streak)) {
                console.log('Celebrating streak:', streak); // Debug log
                
                const intensity = Math.min(streak / 10, 1);
                
                // Launch confetti
                confetti({
                    particleCount: 100 + (streak * 10),
                    spread: 70 + (streak * 2),
                    origin: { y: 0.6 },
                    colors: ['#FFD700', '#FFA500', '#FF4500'],
                    gravity: 1.2,
                    scalar: intensity,
                    disableForReducedMotion: true
                });

                // Show streak message
                const message = getStreakMessage(streak);
                showStreakMessage(message);
            }
        }

        function getStreakMessage(streak) {
            switch(streak) {
                case 3:
                    return "Nice Streak! ðŸŽ¯";
                case 5:
                    return "Awesome! ðŸŒŸ";
                case 10:
                    return "Incredible! ðŸ”¥";
                case 15:
                    return "Unstoppable! âš¡";
                case 20:
                    return "Legendary! ðŸ‘‘";
                case 25:
                    return "God Mode! ðŸŒˆ";
                case 30:
                    return "Color Master! ðŸŽ¨";
                default:
                    return `${streak} Streak! ðŸŽ‰`;
            }
        }

        function showStreakMessage(message) {
            const container = document.getElementById('streak-message-container');
            if (!container || gameOver) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'retro-message opacity-0 transition-opacity duration-500';
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);

            // Fade in
            setTimeout(() => messageDiv.style.opacity = '1', 0);
            
            // Fade out and remove
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => messageDiv.remove(), 500);
            }, 2000);
        }

        // Modify the existing checkAnswer function
        function checkAnswer(index) {
            if (gameOver) return;

            if (index === differentColorIndex) {
                currentStreak++;
                if (currentStreak > bestStreak) {
                    bestStreak = currentStreak;
                }
                score++;
                difficulty += 0.2;
                
                // Celebrate streak milestones
                celebrateStreak(currentStreak);
                
                // Generate new colors
                currentHSLColor = generateRandomColor();
                differentColorIndex = Math.floor(Math.random() * 6);
            } else {
                gameOver = true;
                currentStreak = 0;
                highestScore = Math.max(highestScore, score);
            }
            updateGameUI();
        }

        // Modify the createGameHTML function to show streaks
        function createGameHTML() {
            // Generate colors for the game
            const colors = [];
            for (let i = 0; i < 6; i++) {
                if (i === differentColorIndex) {
                    const slightlyDifferentColor = {
                        h: (currentHSLColor.h + (8 / Math.sqrt(difficulty))) % 360,
                        s: currentHSLColor.s,
                        l: currentHSLColor.l,
                    };
                    colors.push(hslToHex(
                        slightlyDifferentColor.h,
                        slightlyDifferentColor.s,
                        slightlyDifferentColor.l
                    ));
                } else {
                    colors.push(hslToHex(
                        currentHSLColor.h,
                        currentHSLColor.s,
                        currentHSLColor.l
                    ));
                }
            }

            // Create UI based on selected style
            let gameUI;
            switch(gameStyle) {
                case 'win95':
                    gameUI = createRetroGameUI(colors);
                    break;
                default:
                    gameUI = createModernGameUI(colors);
            }

            return gameUI; // Return just the game UI without the style switcher
        }

        function createModernGameUI(colors) {
            return `
                <div class="w-full">
                    <h1 class="text-sm font-medium text-center mb-4 text-gray-500">
                        Find the block with a different shade or brightness.
                    </h1>
                    <div class="flex justify-between mb-2 px-1">
                        <div class="text-base">
                            <div class="text-[#1D1D1F] font-medium">Score</div>
                            <div class="text-2xl font-semibold">${score}</div>
                        </div>
                        <div class="text-base">
                            <div class="text-[#1D1D1F] font-medium">Streak</div>
                            <div class="text-2xl font-semibold">${currentStreak}</div>
                        </div>
                        <div class="text-base">
                            <div class="text-[#1D1D1F] font-medium">Best</div>
                            <div class="text-2xl font-semibold">${bestStreak}</div>
                        </div>
                    </div>
                    <div id="streak-message-container" class="h-6 flex items-center justify-center"></div>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        ${colors.map((color, index) => `
                            <button 
                                class="aspect-square rounded-2xl transition-all duration-300 shadow-sm hover:shadow-md ${
                                    gameOver && index === differentColorIndex ? "ring-4 ring-green-500" : ""
                                } ${
                                    gameOver && index !== differentColorIndex ? "opacity-50" : ""
                                }" 
                                style="background-color: ${color};" 
                                onclick="checkGameAnswer(${index})"
                                ${gameOver ? "disabled" : ""}>
                            </button>
                        `).join("")}
                    </div>
                    ${
                        gameOver 
                        ? `
                            <div class="mt-4 text-center">
                                <div class="text-base font-medium mb-4">
                                    Game Over | Final Score: ${score} | Best Streak: ${bestStreak}
                                </div>
                                <button 
                                    class="bg-black text-white font-medium py-2 px-6 rounded-full hover:bg-gray-800 transition-colors" 
                                    onclick="restartGame()"
                                >
                                    Play Again
                                </button>
                            </div>
                        ` 
                        : `
                            <div class="text-center text-[#1D1D1F] text-sm font-medium">
                                Pick a block to play.
                            </div>
                        `
                    }
                </div>
            `;
        }

        function createRetroGameUI(colors) {
    return `
        <div class="retro-window w-full h-full flex flex-col">
            <div class="retro-title-bar mb-0">
                ColorMatch v1.0
            </div>
            <div class="flex-grow p-2">
                <div class="flex justify-between pb-2">
                    <div class="retro-score">
                        SCORE: ${score.toString().padStart(5, '0')}
                    </div>
                    <div class="retro-score">
                        STREAK: ${currentStreak.toString().padStart(2, '0')}
                    </div>
                    <div class="retro-score">
                        BEST: ${bestStreak.toString().padStart(2, '0')}
                    </div>
                </div>
                <div id="streak-message-container" class="flex items-center justify-center mb-0"></div>
                <div class="grid grid-cols-3 gap-1 mb-0">
                    ${colors.map((color, index) => `
                        <button 
                            class="retro-button w-full aspect-square ${
                                gameOver && index === differentColorIndex ? "ring-4 ring-green-500" : ""
                            } ${
                                gameOver && index !== differentColorIndex ? "opacity-50" : ""
                            }" 
                            style="background-color: ${color};" 
                            onclick="checkGameAnswer(${index})"
                            ${gameOver ? "disabled" : ""}>
                        </button>
                    `).join("")}
                </div>
                ${
                    gameOver 
                    ? `
                        <div class="text-center mt-2">
                            <div class="retro-message mb-2">
                                GAME OVER | FINAL SCORE: ${score} | BEST STREAK: ${bestStreak}
                            </div>
                            <button class="retro-button px-8 py-2" onclick="restartGame()">
                                New Game
                            </button>
                        </div>
                    ` 
                    : ''
                }
            </div>
        </div>
    `;
}


        function switchGameStyle(style) {
            gameStyle = style;
            
            // Update the UI
            const gameHTML = createGameHTML();
            document.getElementById('feature-content').innerHTML = gameHTML;
            
            // Update the header buttons to reflect the current style
            const headerContent = `
                <div class="flex items-center w-full gap-4">
                    <div class="flex items-center gap-4 min-w-0">
                        <span>Fun</span>
                    </div>
                    <div class="ml-auto inline-flex rounded-lg border border-gray-200 p-1">
                        <button 
                            id="modern-style-btn"
                            class="px-3 py-1 rounded-md text-xs ${style === 'modern' ? 'bg-black text-white' : 'text-gray-600 hover:bg-gray-100'}"
                        >
                            Modern
                        </button>
                        <button 
                            id="win95-style-btn"
                            class="px-3 py-1 rounded-md text-xs ${style === 'win95' ? 'bg-black text-white' : 'text-gray-600 hover:bg-gray-100'}"
                        >
                            Windows 95
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('feature-title').innerHTML = headerContent;
            
            // Reattach event listeners for style buttons
            const modernBtn = document.getElementById('modern-style-btn');
            const win95Btn = document.getElementById('win95-style-btn');
            
            if (modernBtn) {
                modernBtn.addEventListener('click', () => switchGameStyle('modern'));
            }
            if (win95Btn) {
                win95Btn.addEventListener('click', () => switchGameStyle('win95'));
            }
        }

        function updateGameUI() {
            const gameHTML = createGameHTML();
            document.getElementById('feature-content').innerHTML = gameHTML;
        }
    </script>
</body>
</html>